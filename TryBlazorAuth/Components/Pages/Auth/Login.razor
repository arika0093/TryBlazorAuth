@using TryBlazorAuth.Auth
@using BitzArt.Blazor.Auth
@attribute [AllowAnonymous]
@page "/login"

<AuthorizeView>
    <Authorized>
        <MudText>You are already logged in.</MudText>
    </Authorized>
    <NotAuthorized>
        <MudContainer MaxWidth="MaxWidth.Medium">
            <MudStack Spacing="3">
                <MudStack Row Spacing="2">
                    <MudTextField Label="Id" @bind-Value="Id" Variant="Variant.Outlined" FullWidth="true" Margin="Margin.Dense" />
                    <MudTextField Label="Password" @bind-Value="Password" Variant="Variant.Outlined" FullWidth="true" Margin="Margin.Dense" InputType="InputType.Password" />
                </MudStack>
                @if(!string.IsNullOrEmpty(Message))
                {
                    <MudAlert Severity="Severity.Error">@Message</MudAlert>
                }
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="HandleLogin">ログイン</MudButton>
            </MudStack>
        </MudContainer>
    </NotAuthorized>
</AuthorizeView>

@inject NavigationManager Navigation
@inject SimpleLoginService UserService
@code {
    [SupplyParameterFromQuery]
    public string? ReturnUrl { get; set; }

    [SupplyParameterFromQuery]
    public string? Message { get; set; }

    private string Id = "";
    private string Password = "";

    private async Task HandleLogin()
    {
        var payload = new SignInPayload
        {
            Id = Id,
            Password = Password
        };
        var result = await UserService.SignInAsync(payload);
        if(result.IsSuccess)
        {
            Navigation.NavigateTo(ReturnUrl ?? "/", forceLoad: true);
        }
        else
        {
            Navigation.NavigateTo($"/login?message={result.ErrorMessage}&returnUrl={ReturnUrl}", forceLoad: true);
        }
    }
}